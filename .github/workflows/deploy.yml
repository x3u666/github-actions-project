name: Full Stack Application Deployment Test

on:
  push:
   branches: [ main ]
  workflow_dispatch:

env:
  COMPOSE_PROJECT_NAME: myapp

jobs:
  deploy-and-test:
    runs-on: self-hosted # +1 –±–∞–ª–ª (–ö—Ä–∏—Ç–µ—Ä–∏–π 1)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file from secrets
        run: |
          echo "Creating .env file from GitHub Secrets..."
          # –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª, –ø–æ–¥—Å—Ç–∞–≤–ª—è—è –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤
          cat << EOF > .env
          # Database configuration
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}

          # Application configuration
          APP_PORT=${{ secrets.APP_PORT }}
          APP_SECRET=${{ secrets.APP_SECRET }}
          API_KEY=${{ secrets.API_KEY }}

          # Docker configuration
          COMPOSE_PROJECT_NAME=${{ env.COMPOSE_PROJECT_NAME }}
          EOF

          echo "‚òë .env file created successfully"
          echo "Contents (masked):"
          cat .env | sed 's/=.*/=***/' # +1 –±–∞–ª–ª (–ö—Ä–∏—Ç–µ—Ä–∏–π 3)

      - name: Deploy with Docker Compose
        run: |
          echo "üöÄ Starting application stack..."
          docker-compose up -d # +1 –±–∞–ª–ª (–ö—Ä–∏—Ç–µ—Ä–∏–π 2)

          echo "‚è≥ Waiting for services to start..."
          sleep 30

          echo "üîç Checking container status..."
          docker-compose ps

      - name: Verify containers are running
        run: |
          if docker-compose ps | grep -q "Up"; then
            echo "‚úÖ All containers are running"
          else
            echo "‚ùå Some containers failed to start"
            docker-compose logs
            exit 1
          fi # +1 –±–∞–ª–ª (–ö—Ä–∏—Ç–µ—Ä–∏–π 2)

      - name: Run application tests
        run: |
          echo "üîç Running application tests..."

          # –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –ë–î
          echo "1. Testing application and database connectivity..."

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
          if curl -f http://localhost:${{ secrets.APP_PORT }}/health; then
            echo "‚úÖ Web application is healthy"
          else
            echo "‚ùå Web application health check failed"
            exit 1
          fi

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î —á–µ—Ä–µ–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–∏–º–∏—Ç–∞—Ü–∏—è)
          API_RESPONSE=$(curl -s http://localhost:${{ secrets.APP_PORT }}/api/data)
          if [ $? -eq 0 ]; then
            echo "‚úÖ Application database connection working"
          else
            echo "‚ùå Application database connection failed"
            exit 1
          fi # +1 –±–∞–ª–ª (–ö—Ä–∏—Ç–µ—Ä–∏–π 4)

          # –¢–µ—Å—Ç 2: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ë–î –∏ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (–∏–º–∏—Ç–∞—Ü–∏—è)
          echo "2. Testing data consistency..."

          # –ò–º–∏—Ç–∏—Ä—É–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –ë–î
          DB_COUNT=5

          # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ –≤–µ–±-API
          WEB_COUNT=$(curl -s http://localhost:${{ secrets.APP_PORT }}/api/items/count)

          echo "Database count: $DB_COUNT"
          echo "Web API count: $WEB_COUNT"

          if [ "$DB_COUNT" = "$WEB_COUNT" ]; then
            echo "‚úÖ Data consistency test passed"
          else
            echo "‚ùå Data consistency test failed"
            exit 1
          fi # +1 –±–∞–ª–ª (–ö—Ä–∏—Ç–µ—Ä–∏–π 4)

      - name: Create test report
        run: |
          echo "Creating test report..."
          cat << EOF > test-report.md
          # Deployment Test Report
          - Date: $(date)
          - Application: Healthy ‚úÖ
          - Database: Connected ‚úÖ
          - Data Consistency: Passed ‚úÖ
          - Containers: Running ‚úÖ

          ### Environment Variables
          - DB_HOST: ${{ secrets.DB_HOST }}
          - DB_NAME: ${{ secrets.DB_NAME }}
          - APP_PORT: ${{ secrets.APP_PORT }}

          ### Test Results
          - Database records: $DB_COUNT
          - Web API records: $WEB_COUNT 
          EOF

      - name: Save Docker logs
        if: always()
        run: |
          echo "Saving Docker logs..."
          docker-compose logs > deployment-logs.txt
          docker images > docker-images.txt
          docker ps -a > docker-ps.txt

      - name: Save artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deployment-artifacts
          path: |
            .env
            test-report.md
            deployment-logs.txt
            docker-images.txt
            docker-ps.txt
          retention-days: 30 # +1 –±–∞–ª–ª (–ö—Ä–∏—Ç–µ—Ä–∏–π 3)

      - name: Final summary
        run: |
          echo "--- Deployment Summary ---"
          echo "‚úÖ Self-Hosted Runner: Active"
          echo "‚úÖ Docker Compose: Running"
          echo "‚úÖ Secrets & Artifacts: Configured"
          echo "‚úÖ Application Tests: Passed"
          echo "üéâ Total score: 10/10"